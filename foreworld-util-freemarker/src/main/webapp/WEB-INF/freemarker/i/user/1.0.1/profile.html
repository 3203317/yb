<#include "/_pagelet/constant.html"/>
<!DOCTYPE html>
<html lang="zh">
	<head>
		<title>修改资料 | 帐户管理 | 系统原型</title>
		<link rel="stylesheet" href="${(conf_html_cdn)!}js/ace/1.1.2/assets/css/jquery.gritter.css" />
		<#include "/_pagelet/header.html"/>
		<link rel="stylesheet" href="${(conf_html_cdn)!}js/ace/1.1.2/assets/css/bootstrap-editable.css" />
		<style>
		.editableform-loading {
			background: url('${(conf_html_cdn)!}js/ace/1.1.2/assets/css/images/loading.gif') center center no-repeat;
		}
		</style>
	</head>

	<body>
		<#include "/i/default/1.0.2/_pagelet/nav.html"/>

		<div class="main-container container-fluid">
			<a class="menu-toggler" id="menu-toggler" href="#">
				<span class="menu-text"></span>
			</a>

			<#include "/i/default/1.0.2/_pagelet/sidebar.html"/>

			<div class="main-content">
				<div class="breadcrumbs" id="breadcrumbs">
					<ul class="breadcrumb">
						<li>
							<i class="icon-home home-icon"></i>
							<a href="/">首页</a>

							<span class="divider">
								<i class="icon-angle-right arrow-icon"></i>
							</span>
						</li>

						<li>
							帐户管理
							<span class="divider">
								<i class="icon-angle-right arrow-icon"></i>
							</span>
						</li>
						<li class="active">修改资料</li>
					</ul><!--.breadcrumb-->

					<div class="nav-search" id="nav-search">
						<form class="form-search" />
							<span class="input-icon">
								<input type="text" placeholder="搜索" class="input-small nav-search-input" id="nav-search-input" autocomplete="off" />
								<i class="icon-search nav-search-icon"></i>
							</span>
						</form>
					</div><!--#nav-search-->
				</div>

				<div class="page-content">

					<div class="page-header position-relative">
						<h1>
							修改资料
							<small>
								<i class="icon-double-angle-right"></i>
								My Profile
							</small>
						</h1>
					</div><!--/.page-header-->

					<div class="row-fluid">
						<div class="span12">
							<!--PAGE CONTENT BEGINS-->

							<div class="alert alert-block alert-error">
								<button type="button" class="close" data-dismiss="alert">
									<i class="icon-remove"></i>
								</button>

								<strong>
									<i class="icon-info-sign"></i>
									系统提示：
								</strong>

								为了您的账户安全，请尽量使用真实资料。
							</div>

							<div class="row-fluid">
								<div class="span12">
									<div class="tabbable">
										<ul class="nav nav-tabs" id="myTab">
											<li class="active">
												<a data-toggle="tab" href="#info">
													<i class="green icon-edit bigger-110"></i>
													个人资料
												</a>
											</li>
										</ul>

										<div class="tab-content">
											<div id="home" class="tab-pane in active">

												<form id='frm' role='form' class="form-horizontal">
													<input type="hidden" name='verify_token' value='${(verify_token)!}' />

													<div class="control-group">
														<label class="control-label">头像</label>
														<div class="controls">
															<span class="profile-picture">
																<img class="editable" id="avatar" src="${(conf_html_cdn)!}js/ace/1.1.2/assets/avatars/profile-pic.jpg"
																	alt="${(data_user.nickname)!}'s Avatar" />
															</span>
														</div>
													</div>

													<div class="control-group">
														<label class="control-label">昵称</label>

														<div class="controls">
															<input type="text" class='input-large' value='${(data_user.nickname)!}' disabled />
														</div>
													</div>
													<div class="control-group">
														<label class="control-label">手机号</label>

														<div class="controls">
															<input type="text" class='input-large' id='frm_mobile' value='${(data_user.mobile)!}' disabled />
														</div>
													</div>
													<div class="control-group">
														<label class="control-label">电子邮箱</label>

														<div class="controls">
															<input type="text" class='input-large' value='${(data_user.email)!}' disabled />
														</div>
													</div>
													<div class="control-group">
														<label class="control-label" for="frm_real_name">姓名</label>

														<div class="controls">
															<input type="text" class='input-large' id="frm_real_name" name='real_name' placeholder="姓名" value='${(data_user.real_name)!}' />
														</div>
													</div>
													<div class="control-group">
														<label class="control-label" for="frm_alipay_account">支付宝帐号</label>

														<div class="controls">
															<input type="text" class='input-large' id="frm_alipay_account" name='alipay_account' placeholder="支付宝帐号" value='${(data_user.alipay_account)!}' />
														</div>
													</div>
													<div class="control-group">
														<label class="control-label" for="frm_wx_account">微信号</label>

														<div class="controls">
															<input type="text" class='input-large' id="frm_wx_account" name='wx_account' placeholder="微信号" value='${(data_user.wx_account)!}' />
														</div>
													</div>
													<div class="control-group">
														<label class="control-label" for="frm_verify_imgCode">图形验证码</label>

														<div class="controls">
															<input type="text" class='input-small' id="frm_verify_imgCode" name='verify_imgCode' placeholder="图形验证码" />
															<img id='img_verifyCode' style='height:28px' src='' title='点击更换验证码'>
														</div>
													</div>
													<div class="form-actions">
														<button class="btn btn-info" onclick="return false;" id='btn_submit'>
															<i class="icon-ok bigger-110"></i>
															提交
														</button>

														&nbsp; &nbsp;
														<button class="btn" type="reset">
															<i class="icon-undo bigger-110"></i>
															重置
														</button>
													</div>
												</form>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!--PAGE CONTENT ENDS-->
						</div><!--/.span-->
					</div><!--/.row-fluid-->
				</div><!--/.page-content-->

				<#include "/i/default/1.0.2/_pagelet/settings.html"/>
			</div><!--/.main-content-->
		</div><!--/.main-container-->

		<#include "/_pagelet/footer.html"/>
		<#include "/_pagelet/js.html"/>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/jquery.gritter.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/bootbox.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/jquery.hotkeys.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/bootstrap-wysiwyg.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/select2.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/date-time/bootstrap-datepicker.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/x-editable/bootstrap-editable.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/x-editable/ace-editable.min.js"></script>
		<script src="${(conf_html_cdn)!}js/ace/1.1.2/assets/js/jquery.maskedinput.min.js"></script>

		<script>
		$('#img_verifyCode').click(function(){
			showVerifyCode();
		});

		function showVerifyCode(){
			$('#img_verifyCode').attr('src', '/verifyCode.jpg?ts='+ (new Date()).valueOf());
		}

		$(function(){
			showVerifyCode();

			$('#btn_submit').click(function(){
				$.ajax({
					url : '${(conf_html_virtualPath)!}user/profile',
					type : 'POST',
					dataType : 'JSON',
					data : $('#frm').serializeObjectForm(),
					success : function(data) {
						if (data.success){
							alert('修改资料成功');
							return location.href = '${(conf_html_virtualPath)!}user/profile';
						}
						if (data.msg) alert(data.msg);
						location.href = '${(conf_html_virtualPath)!}user/profile';
					},
					error : function() {
						alert(arguments[2]);
					}
				});
			});
		});

		/* 头像 */
		$(function() {

			//editables on first profile page
			$.fn.editable.defaults.mode = 'inline';
			$.fn.editableform.loading = "<div class='editableform-loading'><i class='light-blue icon-2x icon-spinner icon-spin'></i></div>";
			$.fn.editableform.buttons = '<button type="submit" class="btn btn-info editable-submit"><i class="icon-ok icon-white"></i></button>'+
		                                '<button type="button" class="btn editable-cancel"><i class="icon-remove"></i></button>';

			// *** editable avatar *** //
			try {//ie8 throws some harmless exception, so let's catch it

				//it seems that editable plugin calls appendChild, and as Image doesn't have it, it causes errors on IE at unpredicted points
				//so let's have a fake appendChild for it!
				if( /msie\s*(8|7|6)/.test(navigator.userAgent.toLowerCase()) ) Image.prototype.appendChild = function(el){};

				var last_gritter;

				$('#avatar').editable({
					type: 'image',
					name: 'avatar',
					value: null,
					image: {
						//specify ace file input plugin's options here
						btn_choose: '选择头像',
						droppable: true,

						/* //this will override the default before_change that only accepts image files
						before_change: function(files, dropped) {
							return true;
						}, */

						//and a few extra ones here
						name: 'avatar',//put the field name here as well, will be used inside the custom plugin
						max_size: 11110000,//~100Kb
						on_error : function(code) {//on_error function will be called when the selected file has a problem
							if(last_gritter) $.gritter.remove(last_gritter);
							if(code == 1) {//file format error
								last_gritter = $.gritter.add({
									title: 'File is not an image!',
									text: 'Please choose a jpg|gif|png image!',
									class_name: 'gritter-error gritter-center'
								});
							} else if(code == 2) {//file size rror
								last_gritter = $.gritter.add({
									title: 'File too big!',
									text: 'Image size should not exceed 100Kb!',
									class_name: 'gritter-error gritter-center'
								});
							}
							else {//other error
							}
						},
						on_success : function() {
							$.gritter.removeAll();
						}
					},
				    url: function(params) {
						// ***UPDATE AVATAR HERE*** //
						//You can replace the contents of this function with examples/profile-avatar-update.js for actual upload

						var deferred = new $.Deferred;

						//if value is empty, means no valid files were selected
						//but it may still be submitted by the plugin, because "" (empty string) is different from previous non-empty value whatever it was
						//so we return just here to prevent problems
						var value = $('#avatar').next().find('input[type=hidden]:eq(0)').val();
						if(!value || value.length == 0) {
							deferred.resolve();
							return deferred.promise();
						}

						//dummy upload
						setTimeout(function(){
							if("FileReader" in window) {
								//for browsers that have a thumbnail of selected image
								var thumb = $('#avatar').next().find('img').data('thumb');
								if(thumb) $('#avatar').get(0).src = thumb;
							}

							deferred.resolve({'status':'OK'});

							if(last_gritter) $.gritter.remove(last_gritter);
							last_gritter = $.gritter.add({
								title: 'Avatar Updated!',
								text: 'Uploading to server can be easily implemented. A working example is included with the template.',
								class_name: 'gritter-info gritter-center'
							});

						 } , parseInt(Math.random() * 800 + 800))

						return deferred.promise();
					},

					success: function(response, newValue) {
					}
				})
			}catch(e) {}

		});
		</script>
	</body>
</html>